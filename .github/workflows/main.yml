name: Build and Scan Container

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: image
        run: |
          if [ "${{ github.ref }}" = "refs/heads/${{ github.event.repository.default_branch }}" ]; then
            echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
          else
            echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.head_ref || github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Build with Kaniko
        id: build
        uses: aevea/action-kaniko@master
        with:
          image: ${{ steps.image.outputs.image }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ${{ env.REGISTRY }}
          cache: true
          cache_repo: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/cache
          context: context
          build_args: |
            AWS_CLI_VERSION=${{ vars.AWS_CLI_VERSION }}
            AWS_CDK_NPM_VERSION=${{ vars.AWS_CDK_NPM_VERSION }}
            AWS_CDK_PY_VERSION=${{ vars.AWS_CDK_PY_VERSION }}

  security-scan:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      security-events: write
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  dependency-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run dependency scan
        uses: github/dependency-review-action@v4
        if: github.event_name == 'pull_request'
